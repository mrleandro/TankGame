<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Tanques 1v1 Online</title>
    <style>
      body {
        background: #111;
        color: white;
        text-align: center;
        font-family: sans-serif;
        margin: 0;
      }
      canvas {
        background: #222;
        display: block;
        margin: 20px auto;
        border: 2px solid #555;
      }
    </style>
  </head>
  <body>
    <h1>Tanques 1v1 Online</h1>
    <p>Controles: W A S D para mover | Espaço para atirar</p>
    <canvas id="game" width="800" height="500"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");
      const largura = canvas.width;
      const altura = canvas.height;

      let player = null;
      let players = {};
      let tiros = [];

      socket.on("init", (data) => {
        player = {
          id: data.id,
          num: data.num,
          x: data.num === 1 ? 150 : 600,
          y: 220,
          dir: "up",
          vida: 3,
        };
      });

      socket.on("updatePlayers", (data) => {
        players = data;
      });

      socket.on("shoot", (tiro) => {
        tiros.push(tiro);
      });

      const teclas = {};
      window.addEventListener(
        "keydown",
        (e) => (teclas[e.key.toLowerCase()] = true)
      );
      window.addEventListener(
        "keyup",
        (e) => (teclas[e.key.toLowerCase()] = false)
      );

      function enviarMovimento() {
        if (!player) return;
        socket.emit("move", { x: player.x, y: player.y, dir: player.dir });
      }

      function atualizar() {
        if (!player) return;

        const vel = 4;
        if (teclas["arrowup"]) {
          player.y -= vel;
          player.dir = "up";
        }
        if (teclas["arrowdown"]) {
          player.y += vel;
          player.dir = "down";
        }
        if (teclas["arrowleft"]) {
          player.x -= vel;
          player.dir = "left";
        }
        if (teclas["arrowright"]) {
          player.x += vel;
          player.dir = "right";
        }

        enviarMovimento();

        // Atirar com espaço
        if (teclas[" "] && !player.cooldown) {
          player.cooldown = 20;
          const tx = player.x + 20,
            ty = player.y + 20;
          tiros.push({ x: tx, y: ty, dir: player.dir, dono: player.num });
          socket.emit("shoot", { x: tx, y: ty, dir: player.dir });
        }
        if (player.cooldown) player.cooldown--;
      }

      function desenhar() {
        ctx.clearRect(0, 0, largura, altura);
        for (const id in players) {
          const p = players[id];
          ctx.fillStyle = p.num === 1 ? "lime" : "cyan";
          ctx.fillRect(p.x, p.y, 40, 40);
          ctx.fillStyle = "white";
          ctx.fillText(`P${p.num}: ${p.vida}`, p.x, p.y - 10);
        }

        ctx.fillStyle = "red";
        tiros.forEach((t) => ctx.fillRect(t.x, t.y, 6, 6));
      }

      function atualizarTiros() {
        tiros.forEach((t) => {
          if (t.dir === "up") t.y -= 8;
          if (t.dir === "down") t.y += 8;
          if (t.dir === "left") t.x -= 8;
          if (t.dir === "right") t.x += 8;
        });

        // colisão simples
        tiros.forEach((t) => {
          for (const id in players) {
            const p = players[id];
            if (
              t.dono !== p.num &&
              t.x < p.x + 40 &&
              t.x + 6 > p.x &&
              t.y < p.y + 40 &&
              t.y + 6 > p.y
            ) {
              socket.emit("hit", p.num);
              t.x = -100; // remove tiro
            }
          }
        });

        tiros = tiros.filter(
          (t) => t.x > 0 && t.x < largura && t.y > 0 && t.y < altura
        );
      }

      function loop() {
        atualizar();
        atualizarTiros();
        desenhar();
        requestAnimationFrame(loop);
      }
      loop();
    </script>
  </body>
</html>
