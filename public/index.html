<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Tanques Online - até 10 Jogadores</title>
    <style>
      body {
        background: #111;
        color: white;
        text-align: center;
        font-family: sans-serif;
        margin: 0;
      }
      canvas {
        background: #222;
        display: block;
        margin: 20px auto;
        border: 2px solid #555;
      }
    </style>
  </head>
  <body>
    <h1>Tanques Online (até 10 jogadores)</h1>
    <p>Controles: Setas para mover | Espaço para atirar</p>
    <canvas id="game" width="800" height="500"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      // ID único do jogador (permanece mesmo após atualizar a página)
      let clientId = localStorage.getItem("tank_client_id");

      if (!clientId) {
        clientId = crypto.randomUUID();
        localStorage.setItem("tank_client_id", clientId);
      }

      const socket = io();

      socket.emit("join", clientId);

      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");
      const largura = canvas.width;
      const altura = canvas.height;

      let player = null;
      let players = {};
      let tiros = [];

      // Se o servidor estiver cheio
      socket.on("full", (msg) => alert(msg));

      // Inicialização do jogador
      socket.on("init", (data) => {
        player = data.players[data.id];
        players = data.players;
      });

      // Atualizações de estado do servidor
      socket.on("updatePlayers", (data) => {
        players = data;
      });

      // Quando outro jogador atira
      socket.on("shoot", (tiro) => {
        tiros.push(tiro);
      });

      // Controles
      const teclas = {};
      window.addEventListener("keydown", (e) => (teclas[e.key] = true));
      window.addEventListener("keyup", (e) => (teclas[e.key] = false));

      function enviarMovimento() {
        if (!player) return;
        socket.emit("move", { x: player.x, y: player.y, dir: player.dir });
      }

      function atualizar() {
        if (!player) return;

        const vel = 4;

        if (teclas["ArrowUp"]) {
          player.y -= vel;
          player.dir = "up";
        }
        if (teclas["ArrowDown"]) {
          player.y += vel;
          player.dir = "down";
        }
        if (teclas["ArrowLeft"]) {
          player.x -= vel;
          player.dir = "left";
        }
        if (teclas["ArrowRight"]) {
          player.x += vel;
          player.dir = "right";
        }

        enviarMovimento();

        // Atirar com espaço
        if (teclas[" "] && !player.cooldown) {
          player.cooldown = 20;
          const tx = player.x + 20,
            ty = player.y + 20;
          tiros.push({ x: tx, y: ty, dir: player.dir, dono: player.id });
          socket.emit("shoot", { x: tx, y: ty, dir: player.dir });
        }

        if (player.cooldown) player.cooldown--;
      }

      function atualizarTiros() {
        tiros.forEach((t) => {
          if (t.dir === "up") t.y -= 8;
          if (t.dir === "down") t.y += 8;
          if (t.dir === "left") t.x -= 8;
          if (t.dir === "right") t.x += 8;
        });

        // Verificar colisões simples
        tiros.forEach((t) => {
          for (const id in players) {
            const p = players[id];
            if (
              t.dono !== id &&
              t.x < p.x + 40 &&
              t.x + 6 > p.x &&
              t.y < p.y + 40 &&
              t.y + 6 > p.y
            ) {
              socket.emit("hit", id);
              t.x = -100; // remove o tiro
            }
          }
        });

        tiros = tiros.filter(
          (t) => t.x > 0 && t.x < largura && t.y > 0 && t.y < altura
        );
      }

      function desenhar() {
        ctx.clearRect(0, 0, largura, altura);

        // desenhar jogadores
        for (const id in players) {
          const p = players[id];
          ctx.fillStyle = p.cor;
          ctx.fillRect(p.x, p.y, 40, 40);
          ctx.fillStyle = "white";
          ctx.font = "14px Arial";
          ctx.fillText(`❤️ ${p.vida}`, p.x, p.y - 8);
        }

        // desenhar tiros
        ctx.fillStyle = "red";
        tiros.forEach((t) => ctx.fillRect(t.x, t.y, 6, 6));
      }

      function loop() {
        atualizar();
        atualizarTiros();
        desenhar();
        requestAnimationFrame(loop);
      }
      loop();
    </script>
  </body>
</html>
