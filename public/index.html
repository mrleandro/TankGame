<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Tanques Online - até 10 Jogadores</title>
    <style>
      body {
        background: #111;
        color: white;
        text-align: center;
        font-family: sans-serif;
        margin: 0;
      }
      canvas {
        background: #222;
        display: block;
        margin: 20px auto;
        border: 2px solid #555;
      }
    </style>
  </head>
  <body>
    <h1>Tanques Online (até 10 jogadores)</h1>
    <p>Controles: Setas para mover | Espaço para atirar</p>

    <button id="respawnBtn" style="display: none">Respawn</button>
    <canvas id="game" width="800" height="500"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      /* ====== ID persistente ====== */
      let clientId = localStorage.getItem("tank_client_id");

      if (!clientId) {
        if (window.crypto && window.crypto.randomUUID) {
          clientId = window.crypto.randomUUID();
        } else {
          clientId = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
            /[xy]/g,
            (c) => {
              const r = (Math.random() * 16) | 0;
              const v = c === "x" ? r : (r & 0x3) | 0x8;
              return v.toString(16);
            }
          );
        }
        localStorage.setItem("tank_client_id", clientId);
      }

      /* ====== Configuração ====== */
      const socket = io();
      socket.emit("join", clientId);

      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");
      const largura = canvas.width;
      const altura = canvas.height;
      const respawnBtn = document.getElementById("respawnBtn");

      let player = null;
      let players = {};
      let tiros = [];

      /* ====== Eventos do servidor ====== */
      socket.on("full", (msg) => alert(msg));
      socket.on("init", (data) => {
        player = data.players[data.id];
        players = data.players;
      });
      socket.on("updatePlayers", (data) => (players = data));
      socket.on("shoot", (tiro) => tiros.push(tiro));

      socket.on("playerDead", (id) => {
        if (id === clientId) {
          // Esconde tanque e mostra botão
          respawnBtn.style.display = "block";
        }
      });

      /* ====== Controles ====== */
      const teclas = {};
      window.addEventListener("keydown", (e) => (teclas[e.key] = true));
      window.addEventListener("keyup", (e) => (teclas[e.key] = false));

      respawnBtn.addEventListener("click", () => {
        socket.emit("respawn", clientId);
        respawnBtn.style.display = "none";
      });

      /* ====== Movimento ====== */
      function enviarMovimento() {
        if (!player) return;
        socket.emit("move", { x: player.x, y: player.y, dir: player.dir });
      }

      /* Calcular direção com diagonais */
      function atualizarDirecao() {
        let dx = 0,
          dy = 0;
        if (teclas["ArrowUp"]) dy = -1;
        if (teclas["ArrowDown"]) dy = 1;
        if (teclas["ArrowLeft"]) dx = -1;
        if (teclas["ArrowRight"]) dx = 1;

        if (dx === 0 && dy === 0) return player.dir; // sem movimento

        // Determina direção textual (8 direções)
        if (dx === 0 && dy === -1) return "up";
        if (dx === 0 && dy === 1) return "down";
        if (dx === -1 && dy === 0) return "left";
        if (dx === 1 && dy === 0) return "right";
        if (dx === 1 && dy === -1) return "up-right";
        if (dx === -1 && dy === -1) return "up-left";
        if (dx === 1 && dy === 1) return "down-right";
        if (dx === -1 && dy === 1) return "down-left";
      }

      function atualizar() {
        if (!player || !player.alive) return;

        const vel = 4;
        let dx = 0,
          dy = 0;

        if (teclas["ArrowUp"]) dy -= 1;
        if (teclas["ArrowDown"]) dy += 1;
        if (teclas["ArrowLeft"]) dx -= 1;
        if (teclas["ArrowRight"]) dx += 1;

        if (dx !== 0 || dy !== 0) {
          const len = Math.hypot(dx, dy);
          player.x += (dx / len) * vel;
          player.y += (dy / len) * vel;
          player.dir = atualizarDirecao();
        }

        enviarMovimento();

        if (teclas[" "] && !player.cooldown) {
          player.cooldown = 20;

          const dir = player.dir;
          let angle = 0;
          switch (dir) {
            case "up":
              angle = -Math.PI / 2;
              break;
            case "up-right":
              angle = -Math.PI / 4;
              break;
            case "right":
              angle = 0;
              break;
            case "down-right":
              angle = Math.PI / 4;
              break;
            case "down":
              angle = Math.PI / 2;
              break;
            case "down-left":
              angle = (3 * Math.PI) / 4;
              break;
            case "left":
              angle = Math.PI;
              break;
            case "up-left":
              angle = (-3 * Math.PI) / 4;
              break;
          }

          const tx = player.x + 20 + Math.cos(angle) * 25;
          const ty = player.y + 20 + Math.sin(angle) * 25;

          tiros.push({ x: tx, y: ty, angle, dono: player.id });
          socket.emit("shoot", { x: tx, y: ty, angle, dono: player.id });
        }

        if (player.cooldown) player.cooldown--;
      }

      /* ====== Tiros ====== */
      function atualizarTiros() {
        tiros.forEach((t) => {
          t.x += Math.cos(t.angle) * 8;
          t.y += Math.sin(t.angle) * 8;
        });

        tiros.forEach((t) => {
          for (const id in players) {
            const p = players[id];
            if (
              t.dono !== id &&
              t.x < p.x + 40 &&
              t.x + 6 > p.x &&
              t.y < p.y + 40 &&
              t.y + 6 > p.y
            ) {
              t.x = -100; // remove
              socket.emit("hit", id);
            }
          }
        });

        tiros = tiros.filter(
          (t) => t.x > 0 && t.x < largura && t.y > 0 && t.y < altura
        );
      }

      /* ====== Desenhar tanque ====== */
      function desenharTanque(p) {
        const cx = p.x + 20;
        const cy = p.y + 20;

        // converte direção em ângulo (em radianos)
        let ang = 0;
        switch (p.dir) {
          case "up":
            ang = 0;
            break;
          case "up-right":
            ang = Math.PI / 4;
            break;
          case "right":
            ang = Math.PI / 2;
            break;
          case "down-right":
            ang = (3 * Math.PI) / 4;
            break;
          case "down":
            ang = Math.PI;
            break;
          case "down-left":
            ang = (5 * Math.PI) / 4;
            break;
          case "left":
            ang = (3 * Math.PI) / 2;
            break;
          case "up-left":
            ang = (7 * Math.PI) / 4;
            break;
        }

        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(ang);

        // corpo
        ctx.fillStyle = p.cor;
        ctx.fillRect(-20, -25, 40, 50);

        // torre e cano
        ctx.fillStyle = "gray";
        ctx.fillRect(-10, -15, 20, 30);
        ctx.fillRect(-3, -30, 6, 15);

        ctx.restore();

        // vida
        ctx.fillStyle = "white";
        ctx.font = "14px Arial";
        ctx.fillText(`❤️ ${p.vida}`, p.x, p.y - 8);
      }

      /* ====== Desenhar tudo ====== */
      function desenhar() {
        ctx.clearRect(0, 0, largura, altura);

        for (const id in players) {
          desenharTanque(players[id]);
        }

        ctx.fillStyle = "red";
        tiros.forEach((t) => ctx.fillRect(t.x, t.y, 6, 6));
      }

      /* ====== Loop principal ====== */
      function loop() {
        atualizar();
        atualizarTiros();
        desenhar();
        requestAnimationFrame(loop);
      }
      loop();
    </script>
  </body>
</html>
